---
title: "Nonlinear Models"
author: "Nakul Camasamudram"
date: "11/18/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Generalized Additive Models
===============================

```{r}
# Imports

library(mgcv)
library(tidyr)
library(dplyr)
library(ggplot2)
library(visreg)
```

## Load Data

```{r}
set.seed(123)

## Read data

boston.dboth <- read.csv("./data/boston_dboth.csv", sep = ",", header=TRUE, na.strings=c("", " ", "NA"))
boston.dairport <- read.csv("./data/boston_dairport.csv", sep = ",", header=TRUE, na.strings=c("", " ", "NA"))
boston.ddowntown <- read.csv("./data/boston_ddowntown.csv", sep = ",", header=TRUE, na.strings=c("", " ", "NA"))
```

```{r}
# Split into train and test data
ratio <- sample(1:nrow(boston.dboth), 0.7*nrow(boston.dboth))
boston.dboth.train <- boston.dboth[ratio, ]
boston.dboth.test <- boston.dboth[-ratio, ]
```

### EDA

```{r, warning=FALSE}
continuous_features <- c("bedrooms", "guests_included", "beds", "bathrooms", "minimum_nights", "accommodates", "number_of_reviews", "ddowntown", "dairport", "price")

dmelt <- gather(select(boston.dboth, continuous_features), key=Variable, value=Value, -price)

scatterwrap <- ggplot(aes(x=Value,y=price), data=dmelt) +
  geom_point(color='#FF5503',alpha=.75) +
  geom_smooth(se=F) + 
  facet_wrap(~Variable, scales='free_x') +
  labs(x='')

scatterwrap
```

## Build Models

### Single Predictors

```{r}
## Linear model
lm1 <- gam(price ~ dairport, data=boston.dboth.train)
summary(lm1)
```

```{r}
## GAM model
gam1 <- gam(price ~ s(dairport, bs="cr"), data=boston.dboth.train)
summary(gam1)
# plot(gam1, shade = TRUE)
```

```{r}
# Model Comparison
modcomp = data.frame(rbind(c(AIC(lm1), summary(lm1)$sp.criterion, summary(lm1)$r.sq),
                           c(AIC(gam1), summary(gam1)$sp.criterion, summary(gam1)$r.sq)))
colnames(modcomp) = c('AIC', 'GCV', 'R^2^')
rownames(modcomp) = c('LM','GAM')
modcomp

anova(lm1, gam1, test="Chisq")
```


### Multiple Predictors

```{r}
# Linear model
lm2 <- gam(price ~ dairport + ddowntown, data=boston.dboth.train)
summary(lm2)
```

```{r}
# GAM model
gam2 <- gam(price ~ s(dairport) + s(ddowntown), data=boston.dboth.train)
summary(gam2)

visreg(gam2,
       line=list(col="#1e90ff", lwd=2), 
       points=list(cex=.25, col='#ff5503'), 
       fill=list(col='gray90'), ask=F, bty='n', alpha=.5)
```


```{r}
# Plot predictions

fits <- predict(gam2, newdata=boston.dboth.test, type='response', se=T)
predicts <- data.frame(boston.dboth.test, fits) %>% 
  mutate(lower = fit - 1.96*se.fit,
         upper = fit + 1.96*se.fit)

plot_gam2_response <- ggplot(aes(x=dairport,y=fit), data=predicts) +
  geom_ribbon(aes(ymin = lower, ymax=upper), fill='gray') +
  geom_line(color='#1e90ff')
plot_gam2_response
```

### Interaction model

```{r}
gam3 <- gam(price ~ te(dairport, ddowntown), data=boston.dboth.train)
summary(gam3)
```


```{r}
# Model comparison
anova(lm2, gam2, gam3, test="Chisq")
```